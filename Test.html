<!DOCTYPE html>
<html>

<head>
	<meta charset="ISO-8859-1">
	<title>SuperWoman</title>
	<script type="module">
		

		function loadImage(url) {
			return new Promise(resolve => {
				const image = new Image();
				image.addEventListener('load', () => {
					resolve(image);
				});
				image.src = url;
			});
		}


		const PRESSED = 1;
		const RELEASED = 0;

		class KeyboardState {
			constructor() {
				// Wenn der Button gehalten wird
				this.keyStates = new Map();


				this.keyMap = new Map();
			}

			addMapping(keyCode, callback) {
				this.keyMap.set(keyCode, callback);
			}

			handelEvent(event) {
				const { keyCode } = event;

				if (!this.keyMap.has(keyCode)) {
					return;
				}

				event.preventDefault();

				const keyState = event.type === 'keydown' ? PRESSED : RELEASED;

				if (this.keyStates.get(keyCode) === keyState) {
					return;
				}

				this.keyStates.set(keyCode, keyState);

				this.keyMap.get(keyCode)(keyState);
			}

			listenTo(window) {
				['keydown', 'keyup'].forEach(eventName => {
					window.addEventListener(eventName, event => {
						this.handelEvent(event);
					});
				});
			}

		}


		class SpriteSheet {
			constructor(image, width, height) {
				this.image = image;
				this.height = height;
				this.width = width;
				this.tiles = new Map();
			}

			define(name, x, y) {
				const buffer = document.createElement('canvas');
				buffer.width = this.width;
				buffer.height = this.height;
				buffer.getContext('2d')
					.drawImage(this.image, x * this.width, y * this.height, this.width, this.height, 0, 0, this.width, this.height);
				this.tiles.set(name, buffer);
			}

			draw(name, context, x, y) {
				const buffer = this.tiles.get(name);
				context.drawImage(buffer, x, y);
			}

			//drawTiles(name, context, x, y){
			//		this.draw(name,context, x*this.width )
			//	}
		}
		
		//var wegResouce = new Window.Resources.ResXResourceReader('D:/DHBW/3. Semester/Software Engineering/weg.png');


		function loadcity() {
			return loadImage('./resource/city.png')
				.then(image => {
					const sprites = new SpriteSheet(image, 800, 471);
					sprites.define('city', 0, 0);
					sprites.draw('city', context, 0, 0);
				});
		}


		function loadGround() {
			return loadImage('./resource/weg.png')
				.then(image => {
					const sprites = new SpriteSheet(image, 66, 97)
					sprites.define('ground', 0, 0)
					for (let x = 0; x < 14; ++x) {
						sprites.draw('ground', context, x * 66, 471);
					}
				});
		}


		function loadFigur() {
			return loadImage('./resource/superwomanavatar2.png')
				.then(image => {
					const figure = new SpriteSheet(image, 74, 74);
					figure.define('figure', 0, 0);
					figure.draw('figure', context, pos.x, pos.y);
				});
		}

		var isJumping = false;
		var isFalling = false;
		var i;

		function jump() {
			if (isJumping) {
				move(0, -i * 0.05);
				i--;
			}
			else if (isFalling) {
				move(0, i * 0.05);
				i++;
			}

			if (isFalling || isJumping) {
				// Figur stoppt am Boden
				if (pos.y > 399) {
					pos.y = 399;
					isFalling = false;
					i = 0;
				}
				// Figur kann nicht aus oberen Rand raus springen
				if (pos.y < 0) {
					isJumping = false;
					isFalling = true;
					i = i / 2;
				}
				// Wenn Sprunghöhe erreicht ist fängt die Figur an zu fallen
				if (i == 0 && (isFalling || isJumping)) {
					isJumping = false;
					isFalling = true;

				}
			}
		}

		function update() {
			console.log("update");
			loadcity();
			loadGround();

			if (input.keyStates.get(RIGHTARROW)) {
				move(2, 0);
			} else if (input.keyStates.get(LEFTARROW)) {
				move(-2, 0);
			}
			if (input.keyStates.get(SPACE)) {
				if (!isJumping && !isFalling) {
					isJumping = true;
					i = 80;
					console.log('Jump');
				}
			}
			jump();
			loadFigur();


			//setTimeout(loadFigur, 200, pos.x, pos.y);
			//	pos.y += 2;
			//	figure.draw('idle', context, pos.x, pos.y);
			requestAnimationFrame(update);
		}

		function move(x, y) {
			pos.x += x;
			pos.y += y;

			if(pos.x > 730)
			{
				pos.x = 730;
			}
			
		}

		const LEFTARROW = 37;
		const RIGHTARROW = 39;
		const SPACE = 32;
		const input = new KeyboardState();
		input.addMapping(LEFTARROW, keyState => { });
		input.addMapping(RIGHTARROW, keyState => { });
		input.addMapping(SPACE, keyState => { });
		input.listenTo(window);


		const canvas = document.getElementById('screen');
		const context = canvas.getContext('2d');
		context.fillRect(0, 471, 800, 97);


		var pos = {
			x: 40,
			y: 399,
		};

		loadcity();
		loadGround();
		setTimeout(loadFigur, 200, pos.x, pos.y);
		update();

	</script>
</head>

<body>
	<canvas id="screen" width="800" height="1000"></canvas>
</body>

</html>